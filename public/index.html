<!doctype html>
<html lang="en" class="h-full">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sri Adichunchanagiri composite English High School - Student Performance Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Added PapaParse for CSV processing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            box-sizing: border-box;
        }

        * {
            box-sizing: border-box;
        }

        .nav-item {
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.15);
            transform: translateX(8px);
        }

        .nav-item.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-left: 5px solid #ff751f;
            font-weight: 600;
        }

        .metric-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border-left: 5px solid transparent;
        }

        .metric-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-left-color: #ff751f;
        }

        .chart-wrapper {
            position: relative;
            height: 320px;
        }

        .mini-chart-wrapper {
            position: relative;
            height: 200px;
        }

        .student-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .student-row:hover {
            background-color: rgba(255, 117, 31, 0.08);
            transform: scale(1.01);
        }

        .grade-card {
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .grade-card:hover {
            border-color: #ff751f;
            box-shadow: 0 8px 20px rgba(255, 117, 31, 0.2);
            transform: translateY(-4px);
        }

        .heatmap-cell {
            transition: all 0.2s ease;
        }

        .heatmap-cell:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .filter-select {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23347363'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.7rem center;
            background-size: 1.2em 1.2em;
            padding-right: 2.5rem;
        }

        .action-button {
            transition: all 0.2s ease;
        }

        .action-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 24px;
            height: 24px;
            border-radius: 4px;
        }

        .section-header {
            border-bottom: 3px solid #347363;
            padding-bottom: 12px;
            margin-bottom: 24px;
        }

        .status-badge {
            font-weight: 600;
            font-size: 11px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .upload-box {
            border: 2px dashed #cbd5e1;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s;
        }

        .upload-box:hover {
            border-color: #347363;
            background-color: #f0fdf4;
        }

        .insight-card {
            background-color: #f8fafc;
            border-left: 4px solid;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>

<body class="h-full bg-gray-50">
    <!-- Header -->
    <header class="fixed top-0 left-0 right-0 h-20 z-30 shadow-lg" id="header" style="background-color: #347363;">
        <div class="h-full px-8 flex items-center justify-between relative">
            <div class="flex items-center space-x-4">
                <img src="https://www.northsouth.org/wp-content/uploads/2024/09/nsf-logov1.png" alt="School Logo"
                    class="h-14 w-auto rounded-lg shadow-md bg-white p-1" id="logo-icon"
                    onerror="this.src='https://placehold.co/100x100?text=LOGO'">
            </div>
            <div class="absolute left-1/2 transform -translate-x-1/2 text-center w-full max-w-lg">
                <h1 class="text-xl md:text-2xl font-bold text-white" id="dashboard-title">Sri Adichunchanagiri composite
                    English High School</h1>
                <p class="text-xs text-white opacity-90" id="subtitle">Student Performance Analytics Dashboard</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="text-right hidden sm:block">
                    <p class="text-sm font-semibold text-white" id="user-role">Administrator</p>
                    <p class="text-xs text-white opacity-75" id="user-status">Assessment Dashboard</p>
                </div>
                <div class="w-12 h-12 rounded-full flex items-center justify-center text-white text-xl font-bold shadow-md"
                    id="user-avatar" style="background-color: #ff751f;">
                    üë§
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar -->
    <aside class="fixed top-20 left-0 bottom-0 w-72 overflow-y-auto z-20 shadow-xl" id="sidebar"
        style="background-color: #347363;">
        <nav class="p-5 space-y-2">
            <a href="#participation" class="nav-item flex items-center space-x-4 px-5 py-4 rounded-xl text-white"
                data-section="participation"> <span class="text-2xl">‚úÖ</span> <span
                    class="font-medium text-base">Student Participation</span> </a>
            <a href="#overview" class="nav-item flex items-center space-x-4 px-5 py-4 rounded-xl text-white"
                data-section="overview"> <span class="text-2xl">üìä</span> <span
                    class="font-medium text-base">Performance Overview</span> </a>
            <a href="#curriculum-analysis" class="nav-item flex items-center space-x-4 px-5 py-4 rounded-xl text-white"
                data-section="curriculum-analysis"> <span class="text-2xl">üìñ</span> <span
                    class="font-medium text-base">Curriculum Analysis</span> </a>
            <a href="#all-students" class="nav-item flex items-center space-x-4 px-5 py-4 rounded-xl text-white"
                data-section="all-students"> <span class="text-2xl">üë•</span> <span
                    class="font-medium text-base">Student Directory</span> </a>
            <a href="#report-card" class="nav-item flex items-center space-x-4 px-5 py-4 rounded-xl text-white"
                data-section="report-card"> <span class="text-2xl">üìã</span> <span class="font-medium text-base">Student
                    Report Card</span> </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="ml-72 mt-20 p-8 h-full overflow-auto">
        <!-- Data Management Section -->
        <div class="mb-8 p-6 bg-white rounded-2xl shadow-lg border-2 border-gray-100">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center"><span class="text-2xl mr-3">üìÇ</span> Data
                    Management</h3><button onclick="downloadTemplates()"
                    class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg font-bold hover:bg-blue-200 transition-colors flex items-center gap-2">
                    <span>‚¨áÔ∏è</span> Download CSV Templates </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="upload-box">
                    <h4 class="font-bold text-gray-700 mb-2">1. Master List</h4>
                    <p class="text-xs text-gray-500 mb-3">Registered Data.csv</p><input type="file" id="upload-master"
                        accept=".csv"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                </div>
                <div class="upload-box">
                    <h4 class="font-bold text-gray-700 mb-2">2. Math Scores</h4>
                    <p class="text-xs text-gray-500 mb-3">Math Results.csv</p><input type="file" id="upload-math"
                        accept=".csv"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100">
                </div>
                <div class="upload-box">
                    <h4 class="font-bold text-gray-700 mb-2">3. English Scores</h4>
                    <p class="text-xs text-gray-500 mb-3">English Results.csv</p><input type="file" id="upload-english"
                        accept=".csv"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-purple-50 file:text-purple-700 hover:file:bg-purple-100">
                </div>
                <div class="upload-box bg-yellow-50 border-yellow-200">
                    <h4 class="font-bold text-gray-700 mb-2">4. Curriculum Map</h4>
                    <p class="text-xs text-gray-500 mb-3">LO_Mapping.csv</p><input type="file" id="upload-map"
                        accept=".csv"
                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-100 file:text-yellow-700 hover:file:bg-yellow-200">
                </div>
            </div>
            <div class="mt-6 flex justify-end"><button onclick="processUploadedFiles()"
                    class="action-button px-8 py-3 bg-green-600 text-white rounded-xl font-bold shadow-md hover:bg-green-700 flex items-center gap-2">
                    <span>‚ö°</span> Process Uploaded Data </button>
            </div>
            <p id="upload-status" class="text-center mt-3 text-sm font-semibold text-gray-500"></p>
        </div>

        <!-- Participation Section -->
        <section id="participation" class="section-content">
            <div class="section-header">
                <h2 class="text-3xl font-bold text-gray-800" id="participation-section-title">Student Participation</h2>
                <p class="text-sm text-gray-600 mt-1">Detailed participation metrics across grades and school sections
                </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Overall Participation Rate</h3>
                    <div class="mini-chart-wrapper mb-4">
                        <canvas id="participation-donut"></canvas>
                    </div>
                    <div class="text-center">
                        <p class="text-5xl font-bold mb-2" style="color: #347363;" id="participation-rate-display">0%
                        </p>
                        <p class="text-sm text-gray-600">of registered students participated</p>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Participation Breakdown</h3>
                    <div class="space-y-4">
                        <div
                            class="flex items-center justify-between p-5 bg-gradient-to-r from-green-50 to-green-100 rounded-xl border-l-4 border-green-500">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-500 rounded-xl flex items-center justify-center"><span
                                        class="text-2xl">‚úÖ</span>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 text-lg">Participated</p>
                                    <p class="text-sm text-gray-600">Completed assessment</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-green-600" id="participated-count">0</p>
                                <p class="text-xs text-gray-600" id="participated-percentage">0%</p>
                            </div>
                        </div>
                        <div
                            class="flex items-center justify-between p-5 bg-gradient-to-r from-red-50 to-red-100 rounded-xl border-l-4 border-red-500">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-red-500 rounded-xl flex items-center justify-center"><span
                                        class="text-2xl">‚ùå</span>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800 text-lg">Did Not Participate</p>
                                    <p class="text-sm text-gray-600">Absent or no results</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-3xl font-bold text-red-600" id="absent-count">0</p>
                                <p class="text-xs text-gray-600" id="absent-percentage">0%</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2">Grade-wise Participation</h3>
                <p class="text-sm text-gray-600 mb-4">Percentage of student participation per grade (Click on a bar to
                    view students)</p>
                <div class="chart-wrapper">
                    <canvas id="grade-participation-chart"></canvas>
                </div>
            </div>

            <!-- Generic List Container for Participation and Analysis Drill-downs -->
            <div id="general-drilldown-container" class="hidden mt-8 pt-8 border-t-2 border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex flex-col">
                        <h3 class="text-2xl font-bold text-gray-800" id="drilldown-title">Drill-down Results</h3>
                        <p class="text-sm text-gray-500" id="drilldown-subtitle">Detailed breakdown of students</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="participation-filter-wrapper" class="flex items-center gap-2">
                            <label class="text-sm font-bold text-gray-600">Filter:</label>
                            <select id="participation-list-status-filter"
                                class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="all">All Students</option>
                                <option value="participated">Participated Only</option>
                                <option value="absent">Absent Only</option>
                            </select>
                        </div>
                        <button onclick="document.getElementById('general-drilldown-container').classList.add('hidden')"
                            class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-bold transition-colors">
                            ‚úï Close List
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-sm border-collapse">
                        <thead id="drilldown-table-header">
                        </thead>
                        <tbody id="drilldown-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Overview Section -->
        <section id="overview" class="section-content hidden">
            <div class="section-header">
                <h2 class="text-3xl font-bold text-gray-800" id="overview-section-title">Performance Overview</h2>
                <p class="text-sm text-gray-600 mt-1">Key metrics and overall performance summary</p>
            </div>

            <!-- Original Section -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100 mb-8">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Student Gap Distribution (Counts)</h3>
                        <p class="text-sm text-gray-600">Categorization based on curriculum mastery. <br><span
                                class="text-xs italic text-gray-500 font-bold">*At Grade Level = Passed level X-1
                                (Capped at Level 6 for Grades 7-10).</span></p>
                    </div>
                    <div class="flex gap-2">
                        <select id="gap-dist-grade-filter"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-semibold text-gray-700 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="all">All Grades</option>
                        </select>
                        <select id="gap-dist-subject"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-semibold text-gray-700 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="all">All Subjects</option>
                            <option value="math">Mathematics</option>
                            <option value="english">English</option>
                        </select>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-[10px] text-center">
                        <thead>
                            <tr class="bg-gray-100 text-gray-800">
                                <th class="p-2 border font-bold text-left sticky left-0 bg-gray-100 z-10">Grade</th>
                                <th class="p-2 border font-bold bg-green-100 text-green-800">At Grade (Passed X-1)</th>
                                <th class="p-2 border font-bold">1 Yr Below</th>
                                <th class="p-2 border font-bold">2 Yrs Below</th>
                                <th class="p-2 border font-bold">3 Yrs Below</th>
                                <th class="p-2 border font-bold">4 Yrs Below</th>
                                <th class="p-2 border font-bold">5 Yrs Below</th>
                                <th class="p-2 border font-bold bg-red-100 text-red-900">6 Yrs Below</th>
                            </tr>
                        </thead>
                        <tbody id="gap-distribution-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- New Copy: Subject-Specific Comparison -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100 mb-8">
                <div class="flex flex-wrap items-center justify-between mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Subject-Specific Gap Distribution</h3>
                        <p class="text-sm text-gray-600">Side-by-side count comparison for Mathematics and English gaps.
                            Click bars to view student details.</p>
                    </div>
                    <div class="flex gap-2">
                        <select id="gap-dist-grade-filter-subjects"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-semibold text-gray-700 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="all">All Grades</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <h4 class="text-sm font-bold text-blue-600 mb-3 flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-blue-600"></span> Mathematics Gaps
                        </h4>
                        <div class="chart-wrapper h-[350px]">
                            <canvas id="math-gap-chart"></canvas>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-sm font-bold text-green-600 mb-3 flex items-center gap-2">
                            <span class="w-3 h-3 rounded-full bg-green-600"></span> English Gaps
                        </h4>
                        <div class="chart-wrapper h-[350px]">
                            <canvas id="english-gap-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filtered Student List (Shared container for gap drill-downs) -->
            <div id="grade-specific-list-container" class="hidden mt-8 pt-8 border-t-2 border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800" id="selected-grade-title">Filtered Student List
                        </h3>
                        <p class="text-sm text-gray-500">Showing detailed performance for selected criteria</p>
                    </div>
                    <button onclick="document.getElementById('grade-specific-list-container').classList.add('hidden')"
                        class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-bold transition-colors">
                        ‚úï Close List
                    </button>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-blue-50 text-blue-800">
                                <th class="py-4 px-4 text-left border-b font-bold">Student ID</th>
                                <th class="py-4 px-4 text-left border-b font-bold">Name</th>
                                <th class="py-4 px-4 text-center border-b font-bold">Math Mastery</th>
                                <th class="py-4 px-4 text-center border-b font-bold">English Mastery</th>
                                <th class="py-4 px-4 text-center border-b font-bold">Status</th>
                            </tr>
                        </thead>
                        <tbody id="grade-specific-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Curriculum Analysis Section -->
        <section id="curriculum-analysis" class="section-content hidden">
            <div class="section-header">
                <h2 class="text-3xl font-bold text-gray-800">Curriculum & LO Analysis</h2>
                <p class="text-sm text-gray-600 mt-1">Performance breakdown by Learning Objective (LO) from the mapped
                    curriculum</p>
            </div>

            <!-- Question-wise Performance (Central Master Filter Location) -->
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100 mb-8">
                <div class="flex flex-wrap items-center justify-between mb-4">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">Question-wise Performance (Q1 - Q20)</h3>
                        <p class="text-sm text-gray-600">Average percentage of correct answers per question. Click bar
                            to view students.</p>
                    </div>
                    <div class="flex gap-2">
                        <select id="q-perf-subject"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-semibold text-gray-700 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="all">All Subjects</option>
                            <option value="math">Mathematics</option>
                            <option value="english">English</option>
                        </select>
                        <select id="q-perf-grade"
                            class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm font-semibold text-gray-700 bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none">
                            <option value="all">All Grades</option>
                        </select>
                    </div>
                </div>

                <div class="chart-wrapper mb-6">
                    <canvas id="question-performance-chart"></canvas>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full border-collapse text-sm text-center">
                        <thead>
                            <tr class="bg-gray-100 text-gray-800">
                                <th class="p-2 border font-bold">Question</th>
                                <th class="p-2 border">Q1</th>
                                <th class="p-2 border">Q2</th>
                                <th class="p-2 border">Q3</th>
                                <th class="p-2 border">Q4</th>
                                <th class="p-2 border">Q5</th>
                                <th class="p-2 border">Q6</th>
                                <th class="p-2 border">Q7</th>
                                <th class="p-2 border">Q8</th>
                                <th class="p-2 border">Q9</th>
                                <th class="p-2 border">Q10</th>
                                <th class="p-2 border">Q11</th>
                                <th class="p-2 border">Q12</th>
                                <th class="p-2 border">Q13</th>
                                <th class="p-2 border">Q14</th>
                                <th class="p-2 border">Q15</th>
                                <th class="p-2 border">Q16</th>
                                <th class="p-2 border">Q17</th>
                                <th class="p-2 border">Q18</th>
                                <th class="p-2 border">Q19</th>
                                <th class="p-2 border">Q20</th>
                            </tr>
                        </thead>
                        <tbody id="question-stats-body">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100 mb-8">
                <div class="mt-4 pt-4">
                    <h4 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>üìã</span> Detailed LO Performance Breakdown
                    </h4>
                    <p class="text-xs text-gray-500 mb-4">Click any row below to view specific student details for that
                        Learning Objective.</p>
                    <div class="overflow-x-auto rounded-xl border border-gray-200">
                        <table class="w-full text-sm border-collapse text-left">
                            <thead>
                                <tr class="bg-gray-100 text-gray-700">
                                    <th class="py-4 px-4 font-bold border-b">Subject</th>
                                    <th class="py-4 px-4 font-bold border-b">Learning Objective</th>
                                    <th class="py-4 px-4 font-bold border-b text-center">Question(s)</th>
                                    <th class="py-4 px-4 font-bold border-b text-center">Performance %</th>
                                    <th class="py-4 px-4 font-bold border-b text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="lo-detailed-table-body">
                                <tr>
                                    <td colspan="5" class="text-center py-8 text-gray-400 italic">Upload a Curriculum
                                        Map and Result data to populate this table.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Container for Curriculum drill-downs -->
            <div id="curriculum-drilldown-container" class="hidden mt-8 pt-8 border-t-2 border-gray-100">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex flex-col">
                        <h3 class="text-2xl font-bold text-gray-800" id="curriculum-drilldown-title">Analysis Drill-down
                        </h3>
                        <p class="text-sm font-bold text-blue-600 mb-1" id="curriculum-requirement-info"></p>
                        <p class="text-sm text-gray-500" id="curriculum-drilldown-subtitle">Detailed student performance
                            for this selection</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <label class="text-sm font-bold text-gray-600">Result Filter:</label>
                            <select id="curriculum-list-result-filter"
                                class="px-3 py-2 border-2 border-gray-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                                <option value="all">Show All</option>
                                <option value="pass">Correct / Proficient</option>
                                <option value="fail">Incorrect / Needs Focus</option>
                            </select>
                        </div>
                        <button
                            onclick="document.getElementById('curriculum-drilldown-container').classList.add('hidden')"
                            class="px-4 py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 font-bold transition-colors">
                            ‚úï Close List
                        </button>
                    </div>
                </div>
                <div class="overflow-x-auto rounded-xl border border-gray-200">
                    <table class="w-full text-sm border-collapse">
                        <thead id="curriculum-drilldown-header">
                        </thead>
                        <tbody id="curriculum-drilldown-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- All Students Section -->
        <section id="all-students" class="section-content hidden">
            <div class="section-header">
                <h2 class="text-3xl font-bold text-gray-800" id="all-students-section-title">Student Performance
                    Directory</h2>
                <p class="text-sm text-gray-600 mt-1">Complete list of all registered students with mastery levels</p>
            </div>
            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100">
                <div class="mb-6">
                    <div class="flex flex-wrap gap-4 items-center justify-between mb-4">
                        <div class="flex gap-2 flex-1 min-w-[300px]">
                            <input type="text" id="all-student-search" placeholder="üîç Search by student name or ID..."
                                class="flex-1 px-5 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium">
                            <select id="directory-grade-filter"
                                class="px-4 py-3 border-2 border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-medium bg-white text-gray-700">
                                <option value="all">Filter by Grade: All</option>
                            </select>
                        </div>
                        <div class="flex gap-3"><button
                                class="filter-btn px-4 py-2 bg-green-100 text-green-700 rounded-lg font-semibold hover:bg-green-200 text-sm"
                                data-filter="participated">Participated</button> <button
                                class="filter-btn px-4 py-2 bg-red-100 text-red-700 rounded-lg font-semibold hover:bg-red-200 text-sm"
                                data-filter="absent">Absent</button> <button id="clear-filter"
                                class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg font-semibold hover:bg-gray-300 text-sm">Clear
                                Filter</button>
                        </div>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-blue-600 text-white">
                                <th class="text-left py-4 px-3 font-bold border border-blue-700">Student ID</th>
                                <th class="text-left py-4 px-3 font-bold border border-blue-700">Student Name</th>
                                <th class="text-center py-4 px-3 font-bold border border-blue-700">Registered Grade</th>
                                <th class="text-left py-4 px-3 font-bold border border-blue-700">District</th>
                                <th class="text-left py-4 px-3 font-bold border border-blue-700">School</th>
                                <th class="text-center py-4 px-3 font-bold border border-blue-700">Math Mastery</th>
                                <th class="text-center py-4 px-3 font-bold border border-blue-700">English Mastery</th>
                                <th class="text-center py-4 px-3 font-bold border border-blue-700">Status</th>
                            </tr>
                        </thead>
                        <tbody id="all-students-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Report Card Section -->
        <section id="report-card" class="section-content hidden">
            <div class="section-header flex items-center justify-between">
                <div>
                    <h2 class="text-3xl font-bold text-gray-800" id="report-card-section-title">Detailed Student Report
                        Card</h2>
                    <p class="text-sm text-gray-600 mt-1">Comprehensive performance analysis for individual student</p>
                </div><button id="back-to-students"
                    class="action-button px-6 py-3 bg-gray-600 text-white rounded-xl font-bold hover:bg-gray-700 flex items-center space-x-2">
                    <span>‚Üê</span> <span>Back to Students</span> </button>
            </div>
            <div class="bg-gradient-to-r from-blue-600 to-blue-800 p-8 rounded-2xl shadow-xl mb-6 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6">
                        <div class="w-24 h-24 bg-white rounded-2xl flex items-center justify-center text-6xl shadow-lg">
                            üë®‚Äçüéì
                        </div>
                        <div>
                            <h3 class="text-3xl font-bold mb-2" id="report-student-name">Select a student</h3>
                            <div class="grid grid-cols-2 gap-x-8 gap-y-1 text-sm">
                                <p><span class="opacity-75">Student ID:</span> <span class="font-bold"
                                        id="report-student-id">-</span></p>
                                <p><span class="opacity-75">Registered Grade:</span> <span class="font-bold"
                                        id="report-student-grade">-</span></p>
                                <p><span class="opacity-75">School:</span> <span class="font-bold"
                                        id="report-student-school">-</span></p>
                                <p><span class="opacity-75">District:</span> <span class="font-bold"
                                        id="report-student-district">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-3">Performance Insights</h3>
                <div id="report-insights-container">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-blue-500">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìê Mathematics Performance</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between"><span class="text-gray-600 font-semibold">Registered
                                Grade:</span> <span class="font-bold text-gray-800" id="report-math-registered">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600 font-semibold">Mastery Level
                                Achieved:</span> <span class="font-bold text-blue-600 text-2xl"
                                id="report-math-mastery">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600 font-semibold">Gap:</span> <span
                                class="font-bold text-lg" id="report-math-gap">-</span>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg" id="report-math-questions">
                            <p class="text-sm text-gray-700">Breakdown by level will appear here</p>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-green-500">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">üìö English Performance</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between"><span class="text-gray-600 font-semibold">Registered
                                Grade:</span> <span class="font-bold text-gray-800"
                                id="report-english-registered">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600 font-semibold">Mastery Level
                                Achieved:</span> <span class="font-bold text-green-600 text-2xl"
                                id="report-english-mastery">-</span>
                        </div>
                        <div class="flex justify-between"><span class="text-gray-600 font-semibold">Gap:</span> <span
                                class="font-bold text-lg" id="report-english-gap">-</span>
                        </div>
                        <div class="mt-4 p-3 bg-green-50 rounded-lg" id="report-english-questions">
                            <p class="text-sm text-gray-700">Breakdown by level will appear here</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-yellow-100 mb-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Learning Objective Mastery</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-yellow-50 text-gray-800">
                                <th class="text-left py-3 px-4 font-bold border">Learning Objective (LO)</th>
                                <th class="text-center py-3 px-3 font-bold border">Performance %</th>
                                <th class="text-center py-3 px-3 font-bold border">Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-lo-analysis-body">
                            <tr>
                                <td colspan="3" class="text-center py-4 text-gray-500">Upload a Curriculum Map to see LO
                                    analysis.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="bg-white p-6 rounded-2xl shadow-lg border-2 border-gray-100">
                <h3 class="text-xl font-bold text-gray-800 mb-4">Question-Level Performance Analysis</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm border-collapse">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="text-left py-3 px-4 font-bold text-gray-800 border">Grade Level</th>
                                <th class="text-center py-3 px-3 font-bold text-gray-800 border">Math: %</th>
                                <th class="text-center py-3 px-3 font-bold text-gray-800 border">Math: Status</th>
                                <th class="text-center py-3 px-3 font-bold text-gray-800 border">English: %</th>
                                <th class="text-center py-3 px-3 font-bold text-gray-800 border">English: Status</th>
                            </tr>
                        </thead>
                        <tbody id="report-question-analysis">
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <script>
        // ===== DATA MANAGEMENT =====

        function downloadTemplates() {
            const masterHeader = "student_id,first_name,last_name,registered_grade,district,school_name";
            const masterRow1 = "1001,John,Doe,5,District A,School Alpha";
            const masterContent = "data:text/csv;charset=utf-8," + encodeURIComponent(masterHeader + "\n" + masterRow1);

            let assessmentHeader = "login_id";
            for (let i = 1; i <= 20; i++) assessmentHeader += `,q${i}_answer`;
            for (let i = 1; i <= 20; i++) assessmentHeader += `,q${i}_level`;

            let assessmentRow1 = "1001";
            for (let i = 1; i <= 20; i++) assessmentRow1 += `,${i % 2}`;
            for (let i = 1; i <= 20; i++) assessmentRow1 += `,${3 + (i % 3)}`;

            const assessmentContent = "data:text/csv;charset=utf-8," + encodeURIComponent(assessmentHeader + "\n" + assessmentRow1);

            let mapCSV = "grade,subject,question_number,learning_objective\n";
            for (let g = 2; g <= 10; g++) {
                ['Math', 'English'].forEach(sub => {
                    for (let q = 1; q <= 20; q++) {
                        mapCSV += `${g},${sub},${q},\n`;
                    }
                });
            }
            const mapContent = "data:text/csv;charset=utf-8," + encodeURIComponent(mapCSV);

            createDownloadLink(masterContent, "Template_Registered_Data.csv");
            setTimeout(() => createDownloadLink(assessmentContent, "Template_Math_Results.csv"), 500);
            setTimeout(() => createDownloadLink(assessmentContent, "Template_English_Results.csv"), 1000);
            setTimeout(() => createDownloadLink(mapContent, "Template_LO_Mapping.csv"), 1500);
        }

        function createDownloadLink(content, filename) {
            const link = document.createElement("a");
            link.setAttribute("href", content);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function processUploadedFiles() {
            const masterFile = document.getElementById('upload-master').files[0];
            const mathFile = document.getElementById('upload-math').files[0];
            const englishFile = document.getElementById('upload-english').files[0];
            const mapFile = document.getElementById('upload-map').files[0];

            if (!masterFile && !mathFile && !englishFile && !mapFile) {
                alert("Please upload at least one file to process.");
                return;
            }

            const promises = [];
            const statusEl = document.getElementById('upload-status');
            statusEl.textContent = "Processing files...";
            statusEl.className = "text-center mt-3 text-sm font-semibold text-blue-600";

            let combinedData = [];

            const readCSV = (file, type) => {
                return new Promise((resolve) => {
                    if (!file) {
                        resolve();
                        return;
                    }
                    Papa.parse(file, {
                        header: true,
                        skipEmptyLines: true,
                        complete: function (results) {
                            const rows = results.data.map(row => ({ ...row, file_type: type }));
                            combinedData = combinedData.concat(rows);
                            resolve();
                        }
                    });
                });
            };

            promises.push(readCSV(masterFile, 'master'));
            promises.push(readCSV(mathFile, 'math'));
            promises.push(readCSV(englishFile, 'english'));
            promises.push(readCSV(mapFile, 'mapping'));

            Promise.all(promises).then(() => {
                if (combinedData.length > 0) {
                    if (masterFile) {
                        masterList.clear();
                        mathResults.clear();
                        englishResults.clear();
                        allStudentsData = [];
                    }
                    if (mapFile) {
                        loMap.clear();
                    }

                    processSheetData(combinedData);

                    statusEl.textContent = "‚úÖ Data successfully processed! Dashboard updated.";
                    statusEl.className = "text-center mt-3 text-sm font-bold text-green-600";
                    showSection('participation');
                } else {
                    statusEl.textContent = "‚ö†Ô∏è No valid data found in files.";
                    statusEl.className = "text-center mt-3 text-sm font-bold text-red-600";
                }
            });
        }

        // ===== DATA STRUCTURES =====

        let masterList = new Map();
        let mathResults = new Map();
        let englishResults = new Map();
        let loMap = new Map();
        let allStudentsData = [];

        let mathGapChart, englishGapChart, participationDonut, gradeParticipationChart, questionPerformanceChart;

        // Drill-down State Management
        let currentParticipationGrade = null;
        let currentCurriculumDrilldown = { type: null, value: null };

        // ===== CORE ALGORITHM =====

        function calculateMasteryLevel(answers, levels) {
            if (!answers || !levels || answers.length !== levels.length) return 0;
            const stats = {};
            for (let i = 0; i < answers.length; i++) {
                const level = levels[i];
                const ans = answers[i];
                if (isNaN(level) || isNaN(ans)) continue;

                if (!stats[level]) stats[level] = { correct: 0, total: 0 };
                stats[level].total++;
                if (ans === 1) stats[level].correct++;
            }

            for (let g = 11; g >= 1; g--) {
                if (stats[g] && stats[g].total > 0 && (stats[g].correct / stats[g].total) >= 0.60) {
                    return g;
                }
            }
            return 0;
        }

        function processSheetData(sheetData) {
            if (!sheetData || sheetData.length === 0) return;

            const masterRecords = sheetData.filter(r => r.file_type === 'master');
            const mathRecords = sheetData.filter(r => r.file_type === 'math');
            const englishRecords = sheetData.filter(r => r.file_type === 'english');
            const mapRecords = sheetData.filter(r => r.file_type === 'mapping');

            mapRecords.forEach(record => {
                const grade = record.grade || record.grade_level;
                const subject = record.subject;
                const qNum = record.question_number;
                const lo = record.learning_objective;
                if (grade && subject && qNum && lo && lo.trim() !== "") {
                    const normSubject = subject.toLowerCase().includes('math') ? 'Math' : 'English';
                    loMap.set(`${normSubject}-${grade}-${qNum}`, lo.trim());
                }
            });

            masterRecords.forEach(record => {
                const studentId = record.student_id || record.login_id;
                const regGrade = parseInt(record.registered_grade);
                if (studentId && regGrade != 1 && !masterList.has(studentId)) {
                    masterList.set(studentId, {
                        id: studentId,
                        name: `${record.first_name || ''} ${record.last_name || ''}`.trim() || 'Unknown',
                        grade: regGrade || 0,
                        district: record.district || 'Unknown',
                        school: record.school_name || 'Unknown',
                        status: 'Absent'
                    });
                }
            });

            const getLevelVal = (r, key) => {
                const raw = r[key] || r[key.toUpperCase()];
                if (typeof raw === 'string' && raw.trim().toLowerCase() === 'pre-primary') return 0;
                return parseInt(raw);
            };

            const processSubjectRecords = (records, resultMap, subjectName) => {
                records.forEach(record => {
                    const loginId = record.login_id;
                    if (!loginId || !masterList.has(loginId)) return;
                    const answers = [];
                    const levels = [];
                    for (let i = 1; i <= 20; i++) {
                        const ansRaw = record[`q${i}_answer`];
                        const lvlRaw = getLevelVal(record, `q${i}_level`);
                        answers.push(ansRaw === "" || ansRaw === undefined ? NaN : parseInt(ansRaw));
                        levels.push(lvlRaw);
                    }
                    const masteryLevel = calculateMasteryLevel(answers, levels);
                    resultMap.set(loginId, {
                        answers, levels, masteryLevel,
                        stats: calculateLevelStats(answers, levels)
                    });
                    masterList.get(loginId).status = 'Participated';
                });
            };

            processSubjectRecords(mathRecords, mathResults, 'Math');
            processSubjectRecords(englishRecords, englishResults, 'English');

            mergeStudentData();
            updateAllVisualizations();
        }

        function calculateLevelStats(answers, levels) {
            const stats = {};
            for (let i = 0; i < answers.length; i++) {
                const level = levels[i];
                const ans = answers[i];
                if (isNaN(level) || isNaN(ans)) continue;

                if (!stats[level]) stats[level] = { correct: 0, total: 0, percentage: 0 };
                stats[level].total++;
                if (ans === 1) stats[level].correct++;
            }
            Object.keys(stats).forEach(level => {
                if (stats[level].total > 0)
                    stats[level].percentage = (stats[level].correct / stats[level].total) * 100;
            });
            return stats;
        }

        function mergeStudentData() {
            allStudentsData = [];
            masterList.forEach((student, studentId) => {
                if (student.grade == 1) return;

                const mathData = mathResults.get(studentId) || { masteryLevel: 0, stats: {}, answers: [], levels: [] };
                const englishData = englishResults.get(studentId) || { masteryLevel: 0, stats: {}, answers: [], levels: [] };

                const countCorrect = (list) => list.filter(v => v === 1).length;
                const countAttempted = (list) => list.filter(v => !isNaN(v)).length;

                const mathCorrect = countCorrect(mathData.answers);
                const mathAttempted = countAttempted(mathData.answers);
                const englishCorrect = countCorrect(englishData.answers);
                const englishAttempted = countAttempted(englishData.answers);

                const totalAttempted = mathAttempted + englishAttempted;
                const scorePercentage = totalAttempted > 0 ? ((mathCorrect + englishCorrect) / totalAttempted) * 100 : 0;

                const mathMastery = mathData.masteryLevel;
                const englishMastery = englishData.masteryLevel;
                const registeredGrade = student.grade;

                const targetLevel = registeredGrade >= 7 ? 6 : registeredGrade - 1;

                allStudentsData.push({
                    id: student.id, name: student.name, registeredGrade: registeredGrade,
                    district: student.district, school: student.school, status: student.status,
                    mathMastery: mathMastery, englishMastery: englishMastery,
                    mathScore: mathAttempted > 0 ? (mathCorrect / mathAttempted) * 100 : 0,
                    englishScore: englishAttempted > 0 ? (englishCorrect / englishAttempted) * 100 : 0,
                    mathGap: mathMastery - targetLevel,
                    englishGap: englishMastery - targetLevel,
                    mathStats: mathData.stats, englishStats: englishData.stats,
                    scorePercentage: scorePercentage,
                    participated: student.status === 'Participated'
                });
            });
        }

        // ===== UI UPDATES =====

        function updateAllVisualizations() {
            updateKPIMetrics();
            updateCharts();
            populateAllStudentsTable();
            updateFilters();
            updateGapDistributionTable();
            updateQuestionAnalysis();
            updateLOChart();
        }

        function updateLOChart() {
            if (loMap.size === 0) return;

            const gradeFilter = document.getElementById('q-perf-grade').value;
            const subjectFilter = document.getElementById('q-perf-subject').value;
            const loStats = {};

            allStudentsData.forEach(student => {
                if (!student.participated) return;
                if (gradeFilter !== 'all' && student.registeredGrade != gradeFilter) return;

                const addSubjectStats = (subject, resultsMap) => {
                    if ((subjectFilter === 'all' || subjectFilter.toLowerCase() === subject.toLowerCase()) && resultsMap.has(student.id)) {
                        const data = resultsMap.get(student.id);
                        data.answers.forEach((ans, idx) => {
                            if (isNaN(ans)) return;
                            const studentGrade = student.registeredGrade;
                            const loName = loMap.get(`${subject}-${studentGrade}-${idx + 1}`);
                            if (loName) {
                                if (!loStats[loName]) {
                                    loStats[loName] = {
                                        correct: 0,
                                        total: 0,
                                        subject: subject,
                                        questions: new Set()
                                    };
                                }
                                loStats[loName].total++;
                                loStats[loName].questions.add(idx + 1);
                                if (ans === 1) loStats[loName].correct++;
                            }
                        });
                    }
                };
                addSubjectStats('Math', mathResults);
                addSubjectStats('English', englishResults);
            });

            const labels = Object.keys(loStats).sort((a, b) => {
                if (loStats[a].subject !== loStats[b].subject) return loStats[a].subject.localeCompare(loStats[b].subject);
                return a.localeCompare(b);
            });

            const tableBody = document.getElementById('lo-detailed-table-body');
            if (labels.length > 0) {
                tableBody.innerHTML = '';
                labels.forEach(lo => {
                    const s = loStats[lo];
                    const perc = (s.correct / s.total * 100);
                    const passed = perc >= 60;
                    const qNumbers = Array.from(s.questions).sort((a, b) => a - b).map(q => `Q${q}`).join(', ');

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 border-b border-gray-100 transition-colors cursor-pointer";
                    tr.innerHTML = `
                    <td class="py-4 px-4 border-b">
                        <span class="px-2 py-1 rounded text-xs font-bold ${s.subject === 'Math' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}">
                            ${s.subject}
                        </span>
                    </td>
                    <td class="py-4 px-4 font-semibold text-gray-800 border-b">${lo}</td>
                    <td class="py-4 px-4 text-center text-gray-500 font-medium border-b">${qNumbers}</td>
                    <td class="py-4 px-4 text-center font-bold border-b ${passed ? 'text-green-600' : 'text-red-600'}">${perc.toFixed(1)}%</td>
                    <td class="py-4 px-4 text-center border-b">
                        <span class="status-badge px-3 py-1 rounded-full text-[10px] ${passed ? 'bg-green-600 text-white' : 'bg-red-500 text-white'}">
                            ${passed ? 'Proficient' : 'Needs Focus'}
                        </span>
                    </td>
                `;
                    tr.onclick = () => showCurriculumDrilldown('lo', lo);
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400 italic">Upload a Curriculum Map and Result data to populate this table.</td></tr>';
            }
        }

        function updateKPIMetrics() {
            const participatedData = allStudentsData.filter(s => s.participated);
            const totalStudents = allStudentsData.length;
            const participated = participatedData.length;
            const participationRate = totalStudents > 0 ? ((participated / totalStudents) * 100).toFixed(1) : 0;

            document.getElementById('participation-rate-display').textContent = participationRate + '%';
            document.getElementById('participated-count').textContent = participated;
            document.getElementById('participated-percentage').textContent = participationRate + '%';
            document.getElementById('absent-count').textContent = totalStudents - participated;
            document.getElementById('absent-percentage').textContent = (100 - parseFloat(participationRate)).toFixed(1) + '%';
        }

        function updateCharts() {
            const gradeGroups = {};
            allStudentsData.forEach(student => {
                const grade = student.registeredGrade;
                if (!gradeGroups[grade]) gradeGroups[grade] = { mathLevels: [], englishLevels: [], mathScores: [], englishScores: [], count: 0, participated: 0, total: 0 };
                gradeGroups[grade].total++;
                if (student.participated) {
                    gradeGroups[grade].mathLevels.push(student.mathMastery);
                    gradeGroups[grade].englishLevels.push(student.englishMastery);
                    gradeGroups[grade].mathScores.push(student.mathScore);
                    gradeGroups[grade].englishScores.push(student.englishScore);
                    gradeGroups[grade].count++;
                    gradeGroups[grade].participated++;
                }
            });

            const grades = Object.keys(gradeGroups).sort((a, b) => parseInt(a) - parseInt(b));
            const getAvg = (grade, key) => {
                const list = gradeGroups[grade][key];
                return list.length > 0 ? (list.reduce((a, b) => a + b, 0) / list.length).toFixed(1) : 0;
            };

            const totalStudents = allStudentsData.length;
            const participated = allStudentsData.filter(s => s.participated).length;
            const rate = totalStudents > 0 ? (participated / totalStudents * 100) : 0;
            if (participationDonut) {
                participationDonut.data.datasets[0].data = [rate.toFixed(1), (100 - rate).toFixed(1)];
                participationDonut.update();
            }

            if (gradeParticipationChart) {
                const chartGrades = Object.keys(gradeGroups).sort((a, b) => parseInt(a) - parseInt(b));
                gradeParticipationChart.data.labels = chartGrades.map(g => `Grade ${g}`);
                gradeParticipationChart.data.datasets[0].data = chartGrades.map(g => gradeGroups[g].total > 0 ? (gradeGroups[g].participated / gradeGroups[g].total * 100).toFixed(1) : 0);
                gradeParticipationChart.data.datasets[0].counts = chartGrades.map(g => gradeGroups[g].participated);
                gradeParticipationChart.update();
            }
        }

        function updateGapDistributionTable() {
            const tbody = document.getElementById('gap-distribution-body');
            tbody.innerHTML = '';
            const subjectFilter = document.getElementById('gap-dist-subject').value;
            const gradeFilterSelect = document.getElementById('gap-dist-grade-filter').value;
            const gradeFilterSelectSubjects = document.getElementById('gap-dist-grade-filter-subjects').value;

            const uniqueGrades = [...new Set(allStudentsData.map(s => s.registeredGrade))].sort((a, b) => a - b);

            const getDistForSubject = (sub) => {
                const dist = {};
                uniqueGrades.forEach(g => { if (g != 1) { dist[g] = { at: 0 }; for (let i = 1; i <= 6; i++) dist[g][`below${i}`] = 0; } });

                allStudentsData.forEach(s => {
                    if (!s.participated || !dist[s.registeredGrade]) return;
                    let mastery = 0;
                    if (sub === 'all') mastery = (s.mathMastery + s.englishMastery) / 2;
                    else if (sub === 'math') mastery = s.mathMastery;
                    else if (sub === 'english') mastery = s.englishMastery;

                    const prevGradeTarget = s.registeredGrade >= 7 ? 6 : s.registeredGrade - 1;
                    if (mastery >= prevGradeTarget) dist[s.registeredGrade].at++;
                    else {
                        const gapLevels = prevGradeTarget - Math.floor(mastery);
                        const bucket = Math.max(1, Math.min(6, gapLevels));
                        dist[s.registeredGrade][`below${bucket}`]++;
                    }
                });
                return dist;
            };

            const distAll = getDistForSubject(subjectFilter);
            const distMath = getDistForSubject('math');
            const distEng = getDistForSubject('english');

            const tableGrades = Object.keys(distAll).sort((a, b) => parseInt(a) - parseInt(b));

            // Sync Table
            tbody.innerHTML = '';
            tableGrades.forEach(g => {
                if (gradeFilterSelect !== 'all' && g != gradeFilterSelect) return;
                const d = distAll[g];
                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50";
                let colsHtml = `<td class="p-2 border font-bold text-left sticky left-0 bg-white group-hover:bg-gray-50 text-[9px]">Grade ${g}</td>`;
                colsHtml += `<td class="p-2 border font-bold text-green-700 bg-green-50">${d.at}</td>`;
                for (let i = 1; i <= 6; i++) colsHtml += `<td class="p-2 border text-gray-700">${d[`below${i}`]}</td>`;
                row.innerHTML = colsHtml;
                tbody.appendChild(row);
            });

            // Sync Math & English Comparison Charts
            const updateCompareChart = (chart, dist, gradeFilterVal) => {
                if (!chart) return;
                const chartDataGrades = tableGrades.filter(g => gradeFilterVal === 'all' || g == gradeFilterVal);
                chart.data.labels = chartDataGrades.map(g => `Grade ${g}`);
                chart.data.datasets[0].data = chartDataGrades.map(g => dist[g].at);
                for (let i = 1; i <= 6; i++) chart.data.datasets[i].data = chartDataGrades.map(g => dist[g][`below${i}`]);
                chart.update();
            };

            updateCompareChart(mathGapChart, distMath, gradeFilterSelectSubjects);
            updateCompareChart(englishGapChart, distEng, gradeFilterSelectSubjects);
        }

        function showFilteredGapList(gradeNum, gapTypeLabel, explicitSubject = null) {
            const container = document.getElementById('grade-specific-list-container');
            const title = document.getElementById('selected-grade-title');
            const tbody = document.getElementById('grade-specific-table-body');

            let subjectFilter = explicitSubject || document.getElementById('gap-dist-subject').value;

            container.classList.remove('hidden');
            title.textContent = `Students in Grade ${gradeNum} - ${gapTypeLabel} (${subjectFilter.toUpperCase()})`;
            tbody.innerHTML = '';

            const filteredStudents = allStudentsData.filter(s => {
                if (!s.participated || s.registeredGrade !== gradeNum) return false;

                let mastery = 0;
                if (subjectFilter === 'all') mastery = (s.mathMastery + s.englishMastery) / 2;
                else if (subjectFilter === 'math') mastery = s.mathMastery;
                else if (subjectFilter === 'english') mastery = s.englishMastery;

                const prevGradeTarget = s.registeredGrade >= 7 ? 6 : s.registeredGrade - 1;
                const currentGap = prevGradeTarget - Math.floor(mastery);

                if (gapTypeLabel.includes("At Grade")) return mastery >= prevGradeTarget;

                const gapYear = parseInt(gapTypeLabel.charAt(0));
                if (gapYear === 6) return currentGap >= 6;
                return currentGap === gapYear;
            });

            filteredStudents.sort((a, b) => a.name.localeCompare(b.name)).forEach(student => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 border-b border-gray-100 transition-colors cursor-pointer';

                row.innerHTML = `
                <td class="py-4 px-4 font-bold text-blue-600">${student.id}</td>
                <td class="py-4 px-4 font-semibold text-gray-800">${student.name}</td>
                <td class="py-4 px-4 text-center font-bold text-blue-500">${student.mathMastery}</td>
                <td class="py-4 px-4 text-center font-bold text-green-500">${student.englishMastery}</td>
                <td class="py-4 px-4 text-center">
                    <span class="status-badge px-3 py-1 bg-green-100 text-green-700 rounded-lg">Participated</span>
                </td>
            `;
                row.onclick = () => showDetailedStudentReport(student);
                tbody.appendChild(row);
            });

            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Participation Drill-down with Filter logic
        function renderParticipationDrilldown() {
            const container = document.getElementById('general-drilldown-container');
            const title = document.getElementById('drilldown-title');
            const header = document.getElementById('drilldown-table-header');
            const tbody = document.getElementById('drilldown-table-body');
            const filterVal = document.getElementById('participation-list-status-filter').value;

            container.classList.remove('hidden');
            title.textContent = `Grade ${currentParticipationGrade} - Detailed Participation List`;

            header.innerHTML = `
            <tr class="bg-gray-50 text-gray-800">
                <th class="py-4 px-4 text-left font-bold border-b">Student ID</th>
                <th class="py-4 px-4 text-left font-bold border-b">Name</th>
                <th class="py-4 px-4 text-center font-bold border-b">Participation Status</th>
                <th class="py-4 px-4 text-center font-bold border-b">Action</th>
            </tr>
        `;

            const filtered = allStudentsData.filter(s => {
                if (s.registeredGrade !== currentParticipationGrade) return false;
                if (filterVal === 'participated') return s.participated;
                if (filterVal === 'absent') return !s.participated;
                return true;
            }).sort((a, b) => a.name.localeCompare(b.name));

            tbody.innerHTML = '';

            filtered.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 border-b border-gray-100 transition-colors";
                tr.innerHTML = `
                <td class="py-4 px-4 font-bold text-blue-600">${s.id}</td>
                <td class="py-4 px-4 font-semibold text-gray-800">${s.name}</td>
                <td class="py-4 px-4 text-center">
                    <span class="status-badge px-3 py-1 rounded-lg ${s.participated ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                        ${s.status}
                    </span>
                </td>
                <td class="py-4 px-4 text-center">
                    <button class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200 hover:bg-blue-100 font-bold">View Report</button>
                </td>
            `;
                tr.onclick = () => showDetailedStudentReport(s);
                tbody.appendChild(tr);
            });

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400 italic">No students match this filter.</td></tr>';
            }

            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showParticipationDrilldown(gradeNum) {
            currentParticipationGrade = gradeNum;
            renderParticipationDrilldown();
        }

        // Curriculum Drill-down with Filter logic and "Show Question" update
        function renderCurriculumDrilldown() {
            const { type, value } = currentCurriculumDrilldown;
            const container = document.getElementById('curriculum-drilldown-container');
            const title = document.getElementById('curriculum-drilldown-title');
            const header = document.getElementById('curriculum-drilldown-header');
            const tbody = document.getElementById('curriculum-drilldown-body');
            const filterVal = document.getElementById('curriculum-list-result-filter').value;
            const requirementInfo = document.getElementById('curriculum-requirement-info');

            const subjectFilter = document.getElementById('q-perf-subject').value;
            const gradeFilter = document.getElementById('q-perf-grade').value;

            container.classList.remove('hidden');
            tbody.innerHTML = '';
            requirementInfo.textContent = '';

            if (type === 'question') {
                title.textContent = `Question ${value} Analysis`;

                // Show LO info for this specific question
                let loInfo = "Learning Objective: Not mapped for this selection.";
                if (gradeFilter !== 'all' && subjectFilter !== 'all') {
                    const normSubject = subjectFilter.toLowerCase().includes('math') ? 'Math' : 'English';
                    const key = `${normSubject}-${gradeFilter}-${value}`;
                    if (loMap.has(key)) loInfo = `Requirement: ${loMap.get(key)}`;
                } else {
                    loInfo = "Select a specific Grade and Subject to view the mapped Learning Objective.";
                }
                requirementInfo.textContent = loInfo;

                header.innerHTML = `
                <tr class="bg-gray-50 text-gray-800">
                    <th class="py-4 px-4 text-left font-bold border-b">Student ID</th>
                    <th class="py-4 px-4 text-left font-bold border-b">Name</th>
                    <th class="py-4 px-4 text-center font-bold border-b">Grade</th>
                    <th class="py-4 px-4 text-center font-bold border-b">Result</th>
                </tr>
            `;

                allStudentsData.forEach(s => {
                    if (!s.participated) return;
                    if (gradeFilter !== 'all' && s.registeredGrade != gradeFilter) return;

                    const checkAndAddRow = (resultsMap) => {
                        const data = resultsMap.get(s.id);
                        if (data && !isNaN(data.answers[value - 1])) {
                            const correct = data.answers[value - 1] === 1;

                            // Filter logic
                            if (filterVal === 'pass' && !correct) return;
                            if (filterVal === 'fail' && correct) return;

                            const tr = document.createElement('tr');
                            tr.className = "hover:bg-gray-50 border-b border-gray-100 transition-colors cursor-pointer";
                            tr.innerHTML = `
                            <td class="py-4 px-4 font-bold text-blue-600">${s.id}</td>
                            <td class="py-4 px-4 font-semibold text-gray-800">${s.name}</td>
                            <td class="py-4 px-4 text-center">G${s.registeredGrade}</td>
                            <td class="py-4 px-4 text-center">
                                <span class="px-3 py-1 rounded-lg font-bold ${correct ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">
                                    ${correct ? 'Correct' : 'Incorrect'}
                                </span>
                            </td>
                        `;
                            tr.onclick = () => showDetailedStudentReport(s);
                            tbody.appendChild(tr);
                        }
                    };

                    if (subjectFilter === 'all' || subjectFilter === 'math') checkAndAddRow(mathResults);
                    if (subjectFilter === 'all' || subjectFilter === 'english') checkAndAddRow(englishResults);
                });

            } else if (type === 'lo') {
                title.textContent = `LO Analysis: ${value}`;

                // Show associated questions for this LO
                let mappedQs = [];
                loMap.forEach((val, key) => {
                    if (val === value) {
                        const parts = key.split('-');
                        mappedQs.push(`Q${parts[2]} (${parts[0]} G${parts[1]})`);
                    }
                });
                requirementInfo.textContent = mappedQs.length > 0 ? `Associated Questions: ${[...new Set(mappedQs)].join(', ')}` : "";

                header.innerHTML = `
                <tr class="bg-gray-50 text-gray-800">
                    <th class="py-4 px-4 text-left font-bold border-b">Student ID</th>
                    <th class="py-4 px-4 text-left font-bold border-b">Name</th>
                    <th class="py-4 px-4 text-center font-bold border-b">Mastery %</th>
                </tr>
            `;

                allStudentsData.forEach(s => {
                    if (!s.participated) return;
                    if (gradeFilter !== 'all' && s.registeredGrade != gradeFilter) return;

                    let loCorrect = 0;
                    let loTotal = 0;

                    ['Math', 'English'].forEach(sub => {
                        if (subjectFilter !== 'all' && sub.toLowerCase() !== subjectFilter) return;
                        const data = (sub === 'Math' ? mathResults : englishResults).get(s.id);
                        if (data) {
                            data.answers.forEach((ans, idx) => {
                                if (isNaN(ans)) return;
                                const loName = loMap.get(`${sub}-${s.registeredGrade}-${idx + 1}`);
                                if (loName === value) {
                                    loTotal++;
                                    if (ans === 1) loCorrect++;
                                }
                            });
                        }
                    });

                    if (loTotal > 0) {
                        const perc = (loCorrect / loTotal * 100);
                        const passed = perc >= 60;

                        // Filter logic
                        if (filterVal === 'pass' && !passed) return;
                        if (filterVal === 'fail' && passed) return;

                        const tr = document.createElement('tr');
                        tr.className = "hover:bg-gray-50 border-b border-gray-100 transition-colors cursor-pointer";
                        tr.innerHTML = `
                        <td class="py-4 px-4 font-bold text-blue-600">${s.id}</td>
                        <td class="py-4 px-4 font-semibold text-gray-800">${s.name}</td>
                        <td class="py-4 px-4 text-center font-bold ${passed ? 'text-green-600' : 'text-red-600'}">${perc.toFixed(1)}%</td>
                    `;
                        tr.onclick = () => showDetailedStudentReport(s);
                        tbody.appendChild(tr);
                    }
                });
            }

            if (tbody.innerHTML === '') {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400 italic">No matching student data for this selection.</td></tr>';
            }

            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function showCurriculumDrilldown(type, value) {
            currentCurriculumDrilldown = { type, value };
            renderCurriculumDrilldown();
        }

        function updateQuestionAnalysis() {
            const subjectFilter = document.getElementById('q-perf-subject').value;
            const gradeFilter = document.getElementById('q-perf-grade').value;
            const qStats = Array(20).fill(0).map(() => ({ correct: 0, total: 0 }));

            allStudentsData.forEach(s => {
                if (!s.participated || (gradeFilter !== 'all' && s.registeredGrade != gradeFilter)) return;
                const addStats = (resultsMap) => {
                    if (resultsMap.has(s.id)) {
                        resultsMap.get(s.id).answers.forEach((ans, idx) => {
                            if (idx < 20 && !isNaN(ans)) { qStats[idx].total++; if (ans === 1) qStats[idx].correct++; }
                        });
                    }
                };
                if (subjectFilter === 'all' || subjectFilter === 'math') addStats(mathResults);
                if (subjectFilter === 'all' || subjectFilter === 'english') addStats(englishResults);
            });

            const percentages = qStats.map(q => q.total > 0 ? ((q.correct / q.total) * 100).toFixed(1) : 0);
            if (questionPerformanceChart) {
                questionPerformanceChart.data.datasets[0].data = percentages;
                questionPerformanceChart.update();
            }

            const tbody = document.getElementById('question-stats-body');
            tbody.innerHTML = '';
            const row = document.createElement('tr');
            let html = '<td class="p-2 border font-bold bg-gray-50">Avg Score</td>';
            percentages.forEach(p => {
                html += `<td class="p-2 border ${parseFloat(p) >= 60 ? 'text-green-600 font-bold' : 'text-red-600'}">${p}%</td>`;
            });
            row.innerHTML = html;
            tbody.appendChild(row);
        }

        function populateAllStudentsTable(filter = null) {
            const tbody = document.getElementById('all-students-table-body');
            tbody.innerHTML = '';
            let filteredData = [...allStudentsData];

            // Handle the filter buttons (Participated / Absent)
            if (filter === 'participated') filteredData = filteredData.filter(s => s.participated);
            else if (filter === 'absent') filteredData = filteredData.filter(s => !s.participated);

            // Handle the new directory Grade-wise filter
            const directoryGradeFilter = document.getElementById('directory-grade-filter').value;
            if (directoryGradeFilter !== 'all') {
                filteredData = filteredData.filter(s => s.registeredGrade == directoryGradeFilter);
            }

            // Default alphabetical sort for the directory
            filteredData.sort((a, b) => a.name.localeCompare(b.name));

            filteredData.forEach(student => {
                const row = document.createElement('tr');
                row.className = 'student-row border-b border-gray-200';

                row.innerHTML = `
          <td class="py-4 px-3 font-bold text-blue-600 border border-gray-200">${student.id}</td>
          <td class="py-4 px-3 text-gray-800 font-semibold border border-gray-200">${student.name}</td>
          <td class="py-4 px-3 text-center font-bold border border-gray-200">Grade ${student.registeredGrade}</td>
          <td class="py-4 px-3 text-gray-700 border border-gray-200">${student.district}</td>
          <td class="py-4 px-3 text-gray-700 border border-gray-200">${student.school}</td>
          <td class="py-4 px-3 text-center font-bold text-blue-600 border border-gray-200">${student.mathMastery}</td>
          <td class="py-4 px-3 text-center font-bold text-green-600 border border-gray-200">${student.englishMastery}</td>
          <td class="py-4 px-3 text-center border border-gray-200">${student.participated ? '<span class="status-badge px-3 py-1 bg-green-600 text-white rounded-full">‚úì Participated</span>' : '<span class="status-badge px-3 py-1 bg-red-600 text-white rounded-full">‚úó Absent</span>'}</td>
        `;
                row.onclick = () => showDetailedStudentReport(student);
                tbody.appendChild(row);
            });
        }

        function showDetailedStudentReport(student) {
            showSection('report-card');
            document.getElementById('report-student-name').textContent = student.name;
            document.getElementById('report-student-id').textContent = student.id;
            document.getElementById('report-student-grade').textContent = 'Grade ' + student.registeredGrade;
            document.getElementById('report-student-school').textContent = student.school;
            document.getElementById('report-student-district').textContent = student.district;

            const updateSubjectUI = (sub) => {
                const capSub = sub.charAt(0).toUpperCase() + sub.slice(1);
                document.getElementById(`report-${sub}-registered`).textContent = 'Grade ' + student.registeredGrade;
                document.getElementById(`report-${sub}-mastery`).textContent = student[`${sub}Mastery`];
                const gap = student[`${sub}Gap`];
                const gapEl = document.getElementById(`report-${sub}-gap`);
                gapEl.textContent = gap >= 0 ? "At Grade" : Math.abs(gap) + " Yrs Below";
                gapEl.className = `font-bold text-lg ${gap >= 0 ? 'text-green-600' : 'text-red-600'}`;

                const stats = student[`${sub}Stats`];
                const div = document.getElementById(`report-${sub}-questions`);
                if (stats && Object.keys(stats).length > 0) {
                    let html = '<div class="space-y-1">';
                    Object.keys(stats).sort((a, b) => parseInt(a) - parseInt(b)).forEach(lvl => {
                        const s = stats[lvl];
                        const passed = s.percentage >= 60;
                        html += `<div class="flex justify-between text-xs"><span>Level ${lvl}:</span><span class="font-bold ${passed ? 'text-green-600' : 'text-red-600'}">${s.correct}/${s.total} (${s.percentage.toFixed(0)}%) ${passed ? '‚úì' : '‚úó'}</span></div>`;
                    });
                    div.innerHTML = html + '</div>';
                } else div.innerHTML = `<p class="text-sm text-gray-500">No ${capSub} assessment data</p>`;
            };

            updateSubjectUI('math');
            updateSubjectUI('english');

            const insightContainer = document.getElementById('report-insights-container');
            insightContainer.innerHTML = '';
            ['math', 'english'].forEach(sub => {
                const gap = student[`${sub}Gap`];
                const color = gap >= 0 ? 'green' : 'red';
                const label = sub.charAt(0).toUpperCase() + sub.slice(1);
                const msg = gap >= 0 ? `‚úÖ ${label} On Track: Mastery confirmed.` : `‚ö†Ô∏è ${label} Support Needed: Gap detected.`;
                insightContainer.innerHTML += `<div class="insight-card border-${color}-500 text-${color}-800"><strong>${msg}</strong></div>`;
            });

            const loTableBody = document.getElementById('report-lo-analysis-body');
            loTableBody.innerHTML = '';
            if (loMap.size > 0) {
                const stats = {};
                ['Math', 'English'].forEach(sub => {
                    const data = (sub === 'Math' ? mathResults : englishResults).get(student.id);
                    if (data) data.answers.forEach((ans, idx) => {
                        if (isNaN(ans)) return;
                        const lo = loMap.get(`${sub}-${student.registeredGrade}-${idx + 1}`);
                        if (lo) { if (!stats[lo]) stats[lo] = { correct: 0, total: 0 }; stats[lo].total++; if (ans === 1) stats[lo].correct++; }
                    });
                });
                const keys = Object.keys(stats).sort();
                if (keys.length > 0) keys.forEach(lo => {
                    const s = stats[lo]; const perc = (s.correct / s.total * 100); const passed = perc >= 60;
                    const tr = document.createElement('tr'); tr.className = "border-b border-yellow-50";
                    tr.innerHTML = `<td class="text-left py-3 px-4 font-bold text-gray-700 border">${lo}</td><td class="text-center py-3 px-3 font-bold border ${passed ? 'text-green-600' : 'text-red-600'}">${perc.toFixed(0)}%</td><td class="text-center py-3 px-3 border"><span class="status-badge px-3 py-1 rounded-lg ${passed ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}">${passed ? 'Passed' : 'Needs Review'}</span></td>`;
                    loTableBody.appendChild(tr);
                }); else loTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">No matching LO data.</td></tr>';
            } else loTableBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Upload a Curriculum Map.</td></tr>';

            // Update question table
            const qBody = document.getElementById('report-question-analysis');
            qBody.innerHTML = '';
            const grades = [...new Set([...mathResults.values(), ...englishResults.values()].flatMap(r => r.levels))].filter(l => !isNaN(l)).sort((a, b) => a - b);
            grades.forEach(lvl => {
                const tr = document.createElement('tr');
                const m = student.mathStats[lvl] || { percentage: 0, correct: 0, total: 0 };
                const e = student.englishStats[lvl] || { percentage: 0, correct: 0, total: 0 };
                tr.innerHTML = `
              <td class="py-3 px-4 border">Level ${lvl}</td>
              <td class="py-3 px-3 text-center border font-bold ${m.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">${m.percentage.toFixed(0)}%</td>
              <td class="py-3 px-3 text-center border">${m.percentage >= 60 ? '‚úì' : '‚úó'}</td>
              <td class="py-3 px-3 text-center border font-bold ${e.percentage >= 60 ? 'text-green-600' : 'text-red-600'}">${e.percentage.toFixed(0)}%</td>
              <td class="py-3 px-3 text-center border">${e.percentage >= 60 ? '‚úì' : '‚úó'}</td>
          `;
                qBody.appendChild(tr);
            });
        }

        function updateFilters() {
            const gVals = [...new Set(allStudentsData.map(s => s.registeredGrade))].sort((a, b) => a - b);

            const gapGradeEl = document.getElementById('gap-dist-grade-filter');
            gapGradeEl.innerHTML = '<option value="all">All Grades</option>' + gVals.map(g => `<option value="${g}">Grade ${g}</option>`).join('');

            const gapGradeElSubjects = document.getElementById('gap-dist-grade-filter-subjects');
            gapGradeElSubjects.innerHTML = '<option value="all">All Grades</option>' + gVals.map(g => `<option value="${g}">Grade ${g}</option>`).join('');

            // Update the Directory Grade Filter
            const dirGradeEl = document.getElementById('directory-grade-filter');
            if (dirGradeEl) {
                dirGradeEl.innerHTML = '<option value="all">Filter by Grade: All</option>' + gVals.map(g => `<option value="${g}">Grade ${g}</option>`).join('');
            }

            // Update Curriculum Grade Filter
            const qGradeEl = document.getElementById('q-perf-grade');
            if (qGradeEl) {
                qGradeEl.innerHTML = '<option value="all">All Grades</option>' + gVals.map(g => `<option value="${g}">Grade ${g}</option>`).join('');
            }
        }

        const navItems = document.querySelectorAll('.nav-item');
        const sections = document.querySelectorAll('.section-content');

        function showSection(id) {
            sections.forEach(s => s.classList.add('hidden'));
            navItems.forEach(n => n.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) target.classList.remove('hidden');
            const active = document.querySelector(`[data-section="${id}"]`);
            if (active) active.classList.add('active');
        }

        navItems.forEach(item => { item.onclick = (e) => { e.preventDefault(); showSection(item.getAttribute('data-section')); }; });
        showSection('participation');

        document.getElementById('directory-grade-filter').onchange = () => populateAllStudentsTable();
        document.getElementById('participation-list-status-filter').onchange = () => renderParticipationDrilldown();
        document.getElementById('curriculum-list-result-filter').onchange = () => renderCurriculumDrilldown();
        document.getElementById('q-perf-subject').onchange = () => { updateQuestionAnalysis(); updateLOChart(); };
        document.getElementById('q-perf-grade').onchange = () => { updateQuestionAnalysis(); updateLOChart(); };

        document.getElementById('gap-dist-subject').onchange = updateGapDistributionTable;
        document.getElementById('gap-dist-grade-filter').onchange = updateGapDistributionTable;
        document.getElementById('gap-dist-grade-filter-subjects').onchange = updateGapDistributionTable;

        function initCharts() {
            const createGapChart = (id, sub) => new Chart(document.getElementById(id).getContext('2d'), {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'At Grade (Pass X-1)', data: [], backgroundColor: '#10B981', borderRadius: 4 },
                        { label: '1 Yr Below', data: [], backgroundColor: '#FBBF24', borderRadius: 4 },
                        { label: '2 Yrs Below', data: [], backgroundColor: '#F97316', borderRadius: 4 },
                        { label: '3 Yrs Below', data: [], backgroundColor: '#EF4444', borderRadius: 4 },
                        { label: '4 Yrs Below', data: [], backgroundColor: '#B91C1C', borderRadius: 4 },
                        { label: '5 Yrs Below', data: [], backgroundColor: '#991B1B', borderRadius: 4 },
                        { label: '6 Yrs Below', data: [], backgroundColor: '#4C1D95', borderRadius: 4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const firstPoint = activeEls[0];
                            const chart = activeEls[0].element.$context.chart;
                            const label = chart.data.labels[firstPoint.index];
                            const datasetLabel = chart.data.datasets[firstPoint.datasetIndex].label;
                            const gradeNum = parseInt(label.replace('Grade ', ''));
                            showFilteredGapList(gradeNum, datasetLabel, sub);
                        }
                    },
                    scales: {
                        x: { stacked: false, grid: { display: false } },
                        y: { stacked: false, beginAtZero: true, title: { display: true, text: 'Student Count' } }
                    },
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 9 } } }
                    }
                }
            });

            mathGapChart = createGapChart('math-gap-chart', 'math');
            englishGapChart = createGapChart('english-gap-chart', 'english');

            questionPerformanceChart = new Chart(document.getElementById('question-performance-chart').getContext('2d'), {
                type: 'bar',
                data: { labels: Array.from({ length: 20 }, (_, i) => `Q${i + 1}`), datasets: [{ label: 'Average Correct %', data: Array(20).fill(0), backgroundColor: '#8b5cf6', borderRadius: 4 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const firstPoint = activeEls[0];
                            const label = questionPerformanceChart.data.labels[firstPoint.index];
                            const qNum = parseInt(label.replace('Q', ''));
                            showCurriculumDrilldown('question', qNum);
                        }
                    }
                }
            });

            participationDonut = new Chart(document.getElementById('participation-donut').getContext('2d'), { type: 'doughnut', data: { labels: ['Participated', 'Absent'], datasets: [{ data: [0, 100], backgroundColor: ['#10B981', '#EF4444'], borderWidth: 4, borderColor: '#fff' }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } } });

            gradeParticipationChart = new Chart(document.getElementById('grade-participation-chart').getContext('2d'), {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Participation %', data: [], backgroundColor: '#6366f1', borderRadius: 6 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 100 } },
                    plugins: { tooltip: { callbacks: { label: (c) => `${c.parsed.y}% (${c.dataset.counts[c.dataIndex]} students)` } } },
                    onClick: (e, activeEls) => {
                        if (activeEls.length > 0) {
                            const firstPoint = activeEls[0];
                            const label = gradeParticipationChart.data.labels[firstPoint.index];
                            const gradeNum = parseInt(label.replace('Grade ', ''));
                            showParticipationDrilldown(gradeNum);
                        }
                    }
                }
            });
        }

        document.querySelectorAll('.filter-btn').forEach(b => b.onclick = () => populateAllStudentsTable(b.getAttribute('data-filter')));
        document.getElementById('clear-filter').onclick = () => populateAllStudentsTable();
        document.getElementById('all-student-search').oninput = (e) => {
            const s = e.target.value.toLowerCase();
            document.querySelectorAll('#all-students-table-body tr').forEach(r => r.style.display = r.textContent.toLowerCase().includes(s) ? '' : 'none');
        };
        document.getElementById('back-to-students').onclick = () => showSection('all-students');

        initCharts();
    </script>
</body>

</html>